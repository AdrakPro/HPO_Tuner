#!/bin/bash
#SBATCH --job-name=ga-array-test
#SBATCH --output=test_fold_%a.out
#SBATCH --error=test_blad_fold_%a.err
#SBATCH --partition=lem-gpu-normal
#SBATCH --nodes=1
#SBATCH --time=03:00:00
#SBATCH --gres=gpu:hopper:1
#SBATCH --ntasks 1
#SBATCH --cpus-per-task=7

# ===============================
#   Konfiguracja i informacje
# ===============================
echo "--- TESTOWE ZADANIE TABLICOWE ---"
echo "Zadanie tablicowe $SLURM_ARRAY_JOB_ID, fold $SLURM_ARRAY_TASK_ID"
echo "WÄ™zeÅ‚: $SLURMD_NODENAME"
echo "Data: $(date)"
echo "Katalog roboczy: $(pwd)"
echo "=================================="

# ===============================
#   ModuÅ‚y
# ===============================
source /usr/local/sbin/modules.sh
module load Python/3.12.3-GCCcore-13.3.0 CUDA/12.8.0

# ===============================
#   Åšrodowisko wirtualne
# ===============================
PROJECT_DIR="$HOME/tmp/genetyk/HPO_Tuner"
VENV_PATH="$PROJECT_DIR/.venv"

cd "$PROJECT_DIR" || { echo "âŒ Nie znaleziono katalogu projektu!"; exit 1; }

# SprawdÅº, czy Å›rodowisko istnieje i dziaÅ‚a
if [ ! -x "$VENV_PATH/bin/python3" ]; then
    echo "âš ï¸  Nie znaleziono poprawnego Å›rodowiska Python. TworzÄ™ nowe..."
    rm -rf "$VENV_PATH"
    python3 -m venv "$VENV_PATH"
fi

# Aktywuj Å›rodowisko
source "$VENV_PATH/bin/activate"

# SprawdÅº, czy pip dziaÅ‚a
if ! "$VENV_PATH/bin/pip" --version >/dev/null 2>&1; then
    echo "âš ï¸  Pip nie dziaÅ‚a â€” reinstalacja Å›rodowiska..."
    rm -rf "$VENV_PATH"
    python3 -m venv "$VENV_PATH"
    source "$VENV_PATH/bin/activate"
fi

# Upewnij siÄ™, Å¼e pip dziaÅ‚a
python3 -m ensurepip --upgrade
pip install --upgrade pip setuptools wheel

# Zainstaluj wymagania, jeÅ›li plik istnieje
if [ -f requirements.txt ]; then
    echo "ğŸ“¦ InstalujÄ™ wymagania..."
    pip install -r requirements.txt
else
    echo "âš ï¸  Brak pliku requirements.txt â€” pomijam instalacjÄ™."
fi

# ===============================
#   Uruchomienie eksperymentu
# ===============================
echo "ğŸš€ Uruchamiam eksperyment dla fold-u $SLURM_ARRAY_TASK_ID..."
python3 main.py 

echo "âœ… Test fold $SLURM_ARRAY_TASK_ID zakoÅ„czony pomyÅ›lnie."

